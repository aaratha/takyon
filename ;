#include "audio.h"

#include "globals.h"

AudioManager::AudioManager(Graph &graph)
    : audioInitialized(false), nodes(graph.getNodes()),
      topoOrder(graph.getTopoOrder()) {

  if (audioInitialized)
    return;

  deviceConfig = ma_device_config_init(ma_device_type_playback);
  deviceConfig.playback.format = DEVICE_FORMAT;
  deviceConfig.playback.channels = DEVICE_CHANNELS;
  deviceConfig.sampleRate = DEVICE_SAMPLE_RATE;
  deviceConfig.dataCallback = AudioManager::dataCallback;
  deviceConfig.pUserData = this;

  if (ma_device_init(NULL, &deviceConfig, &device) != MA_SUCCESS) {
    return;
  }

  if (ma_device_start(&device) != MA_SUCCESS) {
    ma_device_uninit(&device);
    return;
  }

  audioInitialized = true;
  running.store(true);
}

AudioManager::~AudioManager() {
  if (audioInitialized) {
    ma_device_uninit(&device);
    audioInitialized = false;
    running.store(false);
  }
}

void AudioManager::dataCallback(ma_device *pDevice, void *pOutput,
                                const void * /*pInput*/, ma_uint32 frameCount) {

}
